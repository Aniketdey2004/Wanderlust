<%layout("/layouts/boilerplate.ejs")%>
<div class="container mt-5">
  <div class="row">
    <div class="col-md-7">
      <div class="card shadow-sm mb-2">
        <div
          class="card-img-top rounded booking-img"
          style="background-image: url('<%= listing.image.url %>')"
        ></div>
        <div class="card-body">
          <h2 class="card-title"><%=listing.title%></h2>
          <p class="text-muted mb-1">
            <%=listing.location%>, <%=listing.country%>
          </p>
          <p class="fs-4 fw-bold">
            â‚¹ <%=listing.price.toLocaleString('en-IN')%> / night
          </p>
          <p><%=listing.description%></p>
        </div>
      </div>
    </div>
    <div class="col-md-5 mb-2">
      <div class="card shadow-lg p-4">
        <h4 class="mb-3">Book Your Stay</h4>
        <form class="needs-validation book-form" novalidate>
          <div class="mb-3">
            <label for="from" class="form-label">From</label>
            <input
              type="date"
              name="from"
              id="from"
              class="form-control"
              required
            />
            <div class="invalid-feedback">Provide Booking Dates!</div>
          </div>
          <div class="mb-3">
            <label for="to" class="form-label">To</label>
            <input
              type="date"
              name="to"
              id="to"
              class="form-control"
              required
            />
            <div class="invalid-feedback">Provide Booking Dates!</div>
          </div>
          <button type="submit" class="btn form-btn w-100 py-2">
            Confirm Booking
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
let listing = <%- JSON.stringify(listing) %>;
let form = document.querySelector('.book-form');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;

  if (!from || !to) {
    alert("Please select both dates.");
    return;
  }

  const date1 = new Date(from);
  const date2 = new Date(to);
  const diffMs = date2 - date1;
  const diffDays = diffMs / (1000 * 60 * 60 * 24);

  if (diffDays < 0) {
    alert("The 'From' date must be before or equal to the 'To' date.");
    return;
  }
  const totalAmount = listing.price * (diffDays + 1);

  const response = await fetch('/payment/createBooking', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ amount: totalAmount })
  });

  if (!response.ok) {
    alert("Error creating payment order.");
    window.location.href = `/listings/<%= listing._id %>`;
    return;
  }

  const order = await response.json();

  const options = {
    key: "<%= process.env.RAZORPAY_KEY %>",
    amount: order.amount,
    currency: order.currency,
    name: "Wanderlust",
    description: "Booking Payment",
    order_id: order.id,
    handler: async function (response) {
      const res = await fetch(`/listings/<%= listing._id %>/book`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          from,
          to,
          paymentId: response.razorpay_payment_id,
          orderId: response.razorpay_order_id,
          signature: response.razorpay_signature
        })
      });

      window.location.href = `/listings/<%= listing._id %>`;
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
});
</script>
